name: MIWXAlerts â€” NWS Alerts to GitHub Issues

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

permissions:
  issues: write
  contents: write

jobs:
  nws-alerts:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Michigan Alerts
        run: |
          curl -s \
            -H "User-Agent: MIWXAlerts GitHub Automation (oodvgwx@outlook.com)" \
            "https://api.weather.gov/alerts/active?area=MI" \
            -o alerts.json

      - name: Filter Qualifying Alerts
        run: |
          jq '
            .features
            | map(select(
                .properties.event == "Severe Thunderstorm Warning" or
                .properties.event == "Tornado Warning" or
                .properties.event == "Severe Thunderstorm Watch" or
                .properties.event == "Tornado Watch" or
                .properties.event == "Winter Storm Warning" or
                .properties.event == "Winter Storm Watch" or
                .properties.event == "Winter Weather Advisory" or
                .properties.event == "Blizzard Warning" or
                .properties.event == "Ice Storm Warning" or
                .properties.event == "Snow Squall Warning"
            ))
          ' alerts.json > filtered.json

      - name: Load Previous State
        run: |
          mkdir -p state
          [ -f state/active_alerts.json ] || echo "{}" > state/active_alerts.json

      - name: Ensure Labels Exist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -e

          declare -A LABEL_COLORS=(
            [nws-alert]="0366d6"
            [tornado-warning]="b60205"
            [tornado-watch]="fbca04"
            [severe-warning]="d93f0b"
            [severe-watch]="f9d0c4"
            [pds]="5319e7"
            [tornado-emergency]="000000"
            [winter]="0052cc"
            [winter-storm-warning]="1d76db"
            [winter-storm-watch]="84b6eb"
            [winter-weather-advisory]="c5def5"
            [blizzard]="002f6c"
            [ice-storm]="5c2d91"
            [snow-squall]="9be9ff"
          )

          for LABEL in "${!LABEL_COLORS[@]}"; do
            if ! gh label list --repo "$REPO" --search "$LABEL" --json name --jq '.[].name' | grep -qx "$LABEL"; then
              gh label create "$LABEL" \
                --repo "$REPO" \
                --color "${LABEL_COLORS[$LABEL]}" \
                --description "MIWXAlerts automated label"
            fi
          done

      - name: Process Alerts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          jq -c '.[]' filtered.json | while read -r ALERT; do
            ID=$(echo "$ALERT" | jq -r '.id')
            EVENT=$(echo "$ALERT" | jq -r '.properties.event')
            DESC=$(echo "$ALERT" | jq -r '.properties.description')
            SENT=$(echo "$ALERT" | jq -r '.properties.sent')
            EXPIRES=$(echo "$ALERT" | jq -r '.properties.expires')
            AREAS=$(echo "$ALERT" | jq -r '.properties.areaDesc')

            LABELS="nws-alert"

            if [ "$EVENT" = "Tornado Warning" ]; then
              LABELS="$LABELS,tornado-warning"
            elif [ "$EVENT" = "Severe Thunderstorm Warning" ]; then
              LABELS="$LABELS,severe-warning"
            elif [ "$EVENT" = "Tornado Watch" ]; then
              LABELS="$LABELS,tornado-watch"
            elif [ "$EVENT" = "Severe Thunderstorm Watch" ]; then
              LABELS="$LABELS,severe-watch"
            elif [ "$EVENT" = "Winter Storm Warning" ]; then
              LABELS="$LABELS,winter,winter-storm-warning"
            elif [ "$EVENT" = "Winter Storm Watch" ]; then
              LABELS="$LABELS,winter,winter-storm-watch"
            elif [ "$EVENT" = "Winter Weather Advisory" ]; then
              LABELS="$LABELS,winter,winter-weather-advisory"
            elif [ "$EVENT" = "Blizzard Warning" ]; then
              LABELS="$LABELS,winter,blizzard"
            elif [ "$EVENT" = "Ice Storm Warning" ]; then
              LABELS="$LABELS,winter,ice-storm"
            elif [ "$EVENT" = "Snow Squall Warning" ]; then
              LABELS="$LABELS,winter,snow-squall"
            fi

            echo "$DESC" | grep -qi "PDS" && LABELS="$LABELS,pds"
            echo "$DESC" | grep -qi "EMERGENCY" && LABELS="$LABELS,tornado-emergency"

            BODY=$(printf "%s\n\n%s\n\n%s\n\n%s\n\n---\n\n%s\n\n---\n\n**NWS Alert ID:** \`%s\`" \
              "**Event:** $EVENT" \
              "**Areas:** $AREAS" \
              "**Issued:** $SENT" \
              "**Expires:** $EXPIRES" \
              "$DESC" \
              "$ID")

            ISSUE=$(gh issue list \
              --repo "$REPO" \
              --search "NWS Alert ID: \`$ID\`" \
              --state open \
              --json number \
              --jq '.[0].number')

            if [ -z "$ISSUE" ]; then
              gh issue create \
                --repo "$REPO" \
                --title "ðŸš¨ $EVENT â€” $AREAS" \
                --body "$BODY" \
                --label "$LABELS"
            else
              gh issue comment \
                --repo "$REPO" \
                --issue "$ISSUE" \
                --body "ðŸ”„ **Alert Update**"
            fi

            jq --arg id "$ID" --arg sent "$SENT" \
              '.[$id] = {sent:$sent}' \
              state/active_alerts.json > state/tmp.json && mv state/tmp.json state/active_alerts.json
          done

          for OLD_ID in $(jq -r 'keys[]' state/active_alerts.json); do
            if ! jq -r '.[].id' filtered.json | grep -q "$OLD_ID"; then
              ISSUE=$(gh issue list \
                --repo "$REPO" \
                --search "NWS Alert ID: \`$OLD_ID\`" \
                --state open \
                --json number \
                --jq '.[0].number')

              if [ -n "$ISSUE" ]; then
                gh issue close \
                  --repo "$REPO" \
                  --issue "$ISSUE" \
                  --comment "âœ… Alert expired or cancelled by NWS."
              fi

              jq "del(.\"$OLD_ID\")" state/active_alerts.json > state/tmp.json && mv state/tmp.json state/active_alerts.json
            fi
          done

      - name: Save State
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add state/active_alerts.json
          git commit -m "MIWXAlerts: update alert state" || echo "No state changes"
          git push
