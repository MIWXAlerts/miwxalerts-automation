name: MIWXAlerts â€” NWS Alerts to GitHub Issues

on:
  schedule:
    - cron: "* * * * *"
  workflow_dispatch: {}

concurrency:
  group: miwxalerts
  cancel-in-progress: true

permissions:
  issues: write
  contents: write

jobs:
  nws-alerts:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      - name: Verify GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh --version

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Michigan Alerts
        run: |
          curl -s \
            -H "User-Agent: MIWXAlerts GitHub Automation (oodvgwx@outlook.com)" \
            "https://api.weather.gov/alerts/active?area=MI" \
            -o alerts.json


      -- name: Filter Qualifying Alerts
  run: |
    jq '
      .features
      | map(select(
          .properties.event == "Severe Thunderstorm Warning" or
          .properties.event == "Tornado Warning" or
          .properties.event == "Severe Thunderstorm Watch" or
          .properties.event == "Tornado Watch" or
          .properties.event == "Winter Storm Warning" or
          .properties.event == "Winter Storm Watch" or
          .properties.event == "Winter Weather Advisory" or
          .properties.event == "Blizzard Warning" or
          .properties.event == "Ice Storm Warning" or
          .properties.event == "Snow Squall Warning"
      ))
    ' alerts.json > filtered.json || echo "[]" > filtered.json

      - name: Extract Active Qualifying IDs
        run: |
          jq -r '.[].id' filtered.json > all_active_ids.txt    

      - name: Load Previous State
        run: |
          mkdir -p state
          [ -f state/active_alerts.json ] || echo "{}" > state/active_alerts.json

      - name: Ensure Labels Exist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          declare -A LABELS=(
            [nws-alert]="0366d6"
            [tornado-warning]="b60205"
            [tornado-watch]="fbca04"
            [severe-warning]="d93f0b"
            [severe-watch]="f9d0c4"
            [pds]="5319e7"
            [tornado-emergency]="000000"
            [winter]="0052cc"
            [winter-storm-warning]="1d76db"
            [winter-storm-watch]="84b6eb"
            [winter-weather-advisory]="c5def5"
            [blizzard]="002f6c"
            [ice-storm]="5c2d91"
            [snow-squall]="9be9ff"
            [expired]="cfd3d7"
          )

          for L in "${!LABELS[@]}"; do
            gh label list --repo "$REPO" --search "$L" --json name --jq '.[].name' | grep -qx "$L" \
              || gh label create "$L" --repo "$REPO" --color "${LABELS[$L]}" --description "MIWXAlerts"
          done

      - name: Process Active Alerts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          jq -c '.[]' filtered.json | while read -r A; do
            ID=$(jq -r '.id' <<<"$A")
            EVENT=$(jq -r '.properties.event' <<<"$A")
            DESC=$(jq -r '.properties.description' <<<"$A")
            SENT=$(jq -r '.properties.sent' <<<"$A")
            EXPIRES=$(jq -r '.properties.expires' <<<"$A")
            AREAS=$(jq -r '.properties.areaDesc' <<<"$A")

            LABELS="nws-alert"
            case "$EVENT" in
              "Tornado Warning") LABELS+=",tornado-warning" ;;
              "Severe Thunderstorm Warning") LABELS+=",severe-warning" ;;
              "Tornado Watch") LABELS+=",tornado-watch" ;;
              "Severe Thunderstorm Watch") LABELS+=",severe-watch" ;;
              "Winter Storm Warning") LABELS+=",winter,winter-storm-warning" ;;
              "Winter Storm Watch") LABELS+=",winter,winter-storm-watch" ;;
              "Winter Weather Advisory") LABELS+=",winter,winter-weather-advisory" ;;
              "Blizzard Warning") LABELS+=",winter,blizzard" ;;
              "Ice Storm Warning") LABELS+=",winter,ice-storm" ;;
              "Snow Squall Warning") LABELS+=",winter,snow-squall" ;;
            esac

            echo "$DESC" | grep -qi PDS && LABELS+=",pds"
            echo "$DESC" | grep -qi EMERGENCY && LABELS+=",tornado-emergency"

            BODY=$(printf "**Event:** %s\n\n**Areas:** %s\n\n**Issued:** %s\n**Expires:** %s\n\n---\n\n%s\n\n---\n\n**NWS Alert ID:** `%s`" \
              "$EVENT" "$AREAS" "$SENT" "$EXPIRES" "$DESC" "$ID")

            ISSUE=$(gh issue list \
              --repo "$REPO" \
              --search "$ID" \
              --state open \
              --json number \
              --jq '.[0].number')

            if [ -z "$ISSUE" ]; then
              gh issue create \
                --repo "$REPO" \
                --title "ðŸš¨ $EVENT â€” $AREAS [$ID]" \
                --body "$BODY" \
                --label "$LABELS"
            fi

            jq --arg id "$ID" '.[$id]={}' state/active_alerts.json > state/tmp.json && mv state/tmp.json state/active_alerts.json
          done

      - name: Close Expired or Cancelled Alerts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          for ID in $(jq -r 'keys[]' state/active_alerts.json); do
            grep -q "$ID" all_active_ids.txt && continue

            ISSUE=$(gh issue list \
              --repo "$REPO" \
              --search "[$ID]" \
              --state open \
              --json number \
              --jq '.[0].number')

            if [ -n "$ISSUE" ]; then
              gh issue edit "$ISSUE" --add-label expired --repo "$REPO"
              gh issue close "$ISSUE" \
                --repo "$REPO" \
                --comment "âœ… Alert expired or cancelled by the National Weather Service."
            fi

            jq "del(.\"$ID\")" state/active_alerts.json > state/tmp.json && mv state/tmp.json state/active_alerts.json
          done

      - name: Save State
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add state/active_alerts.json
          git diff --quiet || git commit -m "MIWXAlerts: update alert state"
          git push
